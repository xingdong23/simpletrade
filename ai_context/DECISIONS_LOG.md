# SimpleTrade 决策日志

**[当前会话日期 时间]: 开发策略调整: 前端优先**
**决策**: 暂停后端功能开发，优先进行 Web 前端主要模块的原型设计与开发。
**原因**:
- 项目需求发生较大调整，需要通过可视化界面快速迭代和确认最终需求细节。
- 避免在需求未完全稳定前投入过多后端开发资源，降低返工风险。
- 前端原型可以作为后续与用户沟通和后端开发的具体蓝图。
**替代方案**: 继续按原计划进行后端开发，或同时进行前后端开发。
**影响**: 后端功能实现将推迟，但能提高需求准确性，降低项目整体风险。前端开发将成为当前阶段的瓶颈。

**[当前会话日期 时间]: 需求重大调整: 内置数据与简化策略**
**决策**: 重新定义 SimpleTrade 平台的核心方向为：
    1.  **数据内置化:** 平台统一提供数据服务（初期美股），用户无需自行管理或上传数据，未来可通过订阅扩展数据源。
    2.  **聚焦策略易用性:** 策略中心提供精选的 vnpy CTA 策略模板和集成的 Qlib AI 策略，并提供简单的选股器构建功能。
    3.  **核心模块:** 明确为数据中心（后台）、策略中心、交易中心、AI分析中心。
**原因**:
- 简化用户操作，降低量化交易门槛，形成差异化竞争优势。
- 使平台定位更清晰，聚焦核心价值（策略应用与实盘交易）。
- 参考了 BigQuant 和 量化大师 等产品的优点。
**替代方案**: 维持原有的用户需自行管理数据的模式；提供更复杂的通用策略开发框架。
**影响**: 项目范围和技术实现发生重大变化，特别是数据管理和策略模块。需要重新设计架构和开发计划。

## 2024-04-13 19:00: 优先完善Web前端
**决策**: 优先完善Web前端而非微信小程序，将微信小程序开发推迟到后期
**原因**:
- Web前端开发更加简单直接，可以更快地实现功能
- 已经有了简单版HTML前端，可以基于此进行扩展
- 微信小程序开发涉及到微信开发者账号和审核等复杂因素
- 先完善Web前端可以更好地验证功能和用户体验
**替代方案**: 按原计划开发微信小程序前端
**影响**: 可以更快地实现功能，提高开发效率，但可能会延迟微信小程序的开发
**未解决的问题**:
- 后期如何将Web前端的功能和体验迁移到微信小程序
- 是否需要考虑响应式设计，使其同时适配移动端和桌面端

## 2024-04-11 17:50: 使用vnpy最新版本
**决策**: 使用vnpy的最新版本（4.0.0+）而非原计划的2.3.0版本
**原因**:
- 最新版本包含更多功能和改进
- 采用了更现代化的插件架构
- 更好的社区支持和维护
**替代方案**: 使用原计划的2.3.0版本
**影响**: 可能需要适应新版本的API变化，但长期来看将获得更好的功能和支持

## 2024-04-11 17:50: 使用conda环境
**决策**: 使用conda环境来管理项目依赖，所有应用安装必须使用conda安装，并且始终使用当前项目的simpletrade conda环境，不创建新的环境
**原因**:
- 更好地处理二进制依赖，特别是TA-Lib等C库
- 提供隔离的环境，避免依赖冲突
- 更容易在不同平台上复现环境
- 使用conda安装可以避免pip安装时的各种兼容性问题
- 使用同一个conda环境可以确保在不同IDE和工作环境中的一致性
**替代方案**: 使用pip、virtualenv或系统Python环境，或为不同工作环境创建多个conda环境

## 2024-04-12 14:00: 基于vnpy开发数据管理功能
**决策**: 开发数据管理功能时直接使用vnpy的数据模型和管理功能，而非自定义实现
**原因**:
- 利用vnpy成熟的数据管理功能，提高代码质量和可靠性
- 保持与vnpy的兼容性，便于后续更新和维护
- 减少代码量，降低维护成本
- 专注于业务逻辑实现，而非底层数据管理
**替代方案**: 完全自定义实现数据模型和管理功能
**影响**:
- 简化了代码结构，减少了开发工作量
- 提高了与vnpy的兼容性
- 可能需要适应vnpy的API变化
- 长期来看将获得更好的功能和支持

## 2024-04-12 16:30: 开发Web前端并重组项目结构
**决策**: 开发简单的Web前端，并重组项目结构，使其更加清晰和有组织
**原因**:
- 需要一个直观的方式来展示和验证后端功能
- Web前端开发速度快，可以快速看到效果
- 重组项目结构可以提高代码的可维护性和可读性
- 为后续开发微信小程序前端做准备
**替代方案**: 直接开发微信小程序前端，或仅使用命令行工具
**影响**:
- 提供了直观的方式来展示和验证后端功能
- 改进了项目结构，使其更加清晰和有组织
- 为微信小程序前端开发提供了参考和基础
- 增加了一定的开发工作量，但长期来看是值得的

## 2024-04-12 17:30: 修复API服务器启动问题
**决策**: 修复API服务器启动问题，并改进启动脚本的错误处理和进程管理
**原因**:
- 在运行 `scripts/start_web_frontend.py` 时遇到API服务器启动错误
- 错误信息显示 `Error loading ASGI app. Attribute "app" not found in module "simpletrade.api.server"`
- 需要增强启动脚本的错误处理和进程管理，使其更加健壮
**替代方案**: 使用其他方式启动API服务器，或完全重写启动脚本
**影响**:
- 修复了API服务器启动问题，使其可以被uvicorn直接运行
- 改进了启动脚本的错误处理和进程管理，使其更加健壮
- 仍然存在npm安装依赖错误问题，可能需要使用国内镜像或手动安装
**未解决的问题**:
- npm安装依赖错误：`npm ERR! code ECONNRESET`，可能是网络问题或代理设置问题

## 2024-04-13 15:30: 创建简单版HTML前端解决Web启动问题
**决策**: 创建简单版HTML前端，并修复API跨域问题和缺失的API端点
**原因**:
- Web前端启动问题中的npm安装依赖错误难以解决
- 需要一个简单的方式来测试API服务器功能
- 在连接API服务器时遇到跨域问题和缺失的API端点
**替代方案**: 继续尝试解决npm安装依赖错误，或使用其他前端框架
**影响**:
- 创建了简单版HTML前端，不依赖npm安装，解决了依赖安装问题
- 在API服务器中添加了CORS中间件，解决了跨域问题
- 实现了缺失的API端点，包括 `/api/data/symbols` 和 `/api/analysis/indicators`
- 创建了新的启动脚本 `scripts/start_simple_web.py`，简化了启动过程
**下一步计划**:
- 开发微信小程序前端，将Web前端的功能移植到微信小程序
- 继续完善API功能，添加更多的端点和功能

## 2024-04-13 17:30: 实现老虎证券Gateway
**决策**: 实现老虎证券Gateway，支持历史数据下载和实时数据订阅
**原因**:
- 需要支持老虎证券的行情和交易功能
- 利用vnpy的Gateway架构，可以快速实现对老虎证券API的集成
- 提供统一的接口，便于后续集成到SimpleTrade中
**替代方案**: 直接使用老虎证券的Python SDK，或者使用其他交易接口
**影响**:
- 成功实现了老虎证券Gateway，支持历史数据下载和实时数据订阅
- 创建了下载历史数据和订阅实时行情的脚本
- 集成到SimpleTrade项目中，便于后续使用
**下一步计划**:
- 编写详细的老虎证券Gateway文档
- 测试老虎证券Gateway的功能

## 2024-04-13 18:00: 编写老虎证券Gateway文档
**决策**: 编写详细的老虎证券Gateway文档，包括集成指南和使用指南
**原因**:
- 需要详细的文档来指导用户使用老虎证券Gateway
- 文档应包含安装、配置、数据下载和实时数据订阅等功能的说明
- 需要将老虎证券Gateway的使用方法集成到项目文档中
**替代方案**: 仅提供简单的使用说明，或将文档内容包含在代码注释中
**影响**:
- 创建了详细的老虎证券Gateway文档，包括集成指南和使用指南
- 更新了项目的README.md文件，添加了老虎证券Gateway相关内容
- 更新了项目状态文档，记录了老虎证券Gateway的实现和文档编写
**下一步计划**:
- 测试老虎证券Gateway的功能，包括历史数据下载和实时数据订阅
- 开发微信小程序前端，将老虎证券Gateway的功能集成到微信小程序中

## 2023-10-15 13:00: AI协作方式优化
**决策**: 采用结构化项目状态文件方法管理AI协作
**原因**:
- 减少每次会话需要重复说明的上下文信息
- 保持项目信息的一致性和完整性
- 便于追踪项目进展和决策历史
**替代方案**: 每次会话手动提供上下文、使用外部工具管理项目状态
**影响**: 开发效率、AI协作质量、知识管理

## 2023-10-15 10:15: 项目名称选择
**决策**: 项目名称确定为"SimpleTrade"
**原因**:
- 名称简洁明了，直接传达了平台的核心价值 - 简单易用的交易体验
- 易于记忆和传播
- 具有国际化潜力
**替代方案**: QuantEdge, TradeMatrix, AlgoWealth等其他名称选项
**影响**: 品牌定位、用户感知、营销策略

## [已废弃] 2023-10-15 10:30: vnpy使用方式
**决策**: 直接使用vnpy源码而非作为依赖安装
**原因**:
- 提供最大的灵活性和控制力
- vnpy核心源码相对简单，易于理解和维护
- 可以深度定制功能，满足特定需求
**替代方案**: 作为依赖安装vnpy，通过扩展实现功能
**影响**: 开发方式、维护成本、功能实现方式

## [已废弃] 2023-10-15 11:00: 前端实现方式
**决策**: 采用微信小程序和消息交互作为主要前端
**原因**:
- 用户可以随时随地通过微信访问系统
- 利用用户已有的使用习惯，降低学习成本
- 消息驱动的交互模式简单直观
**替代方案**: 传统Web界面、桌面应用
**影响**: 用户体验、开发复杂度、功能实现方式

## 2023-10-15 11:30: 项目文档结构
**决策**: 创建全面的项目文档体系，包括执行计划、功能需求、技术规格等
**原因**:
- 确保项目需求和技术路线清晰
- 为开发团队和AI助手提供明确的指导
- 便于项目管理和进度追踪
**替代方案**: 简化文档，直接进入开发阶段
**影响**: 开发质量、团队协作、项目可维护性

## [部分调整] 2023-10-15 14:15: 数据存储方案
**决策**: 使用轻量级数据存储方案(SQLite + 文件存储)
**原因**:
- 适合个人项目和单服务器环境
- 减少资源需求和维护成本
- 简化部署和配置
**替代方案**: 使用MongoDB + Redis + 时序数据库等更复杂的方案
**影响**: 系统性能、可扩展性、维护复杂度
**[更新]**: 新需求下，考虑使用 PostgreSQL + TimescaleDB 以支持未来扩展。

## 2023-10-15 14:40: 项目结构独立化
**决策**: 创建独立的SimpleTrade项目结构，不再依赖于vnpy源码环境
**原因**:
- 清晰的项目边界和职责划分
- 便于管理和版本控制
- 符合标准Python项目结构
**替代方案**: 继续在vnpy源码环境中开发
**影响**: 项目组织、开发流程、代码管理

## [已废弃] 2023-10-15 15:20: vnpy源码集成方式
**决策**: 采用Git子模块方式集成vnpy源码
**原因**:
- 独立版本控制，便于跟踪上游更新
- 可以直接访问和修改vnpy源码，实现深度定制
- 项目结构清晰，便于管理和维护
- 灵活的更新策略，可以选择性更新
**替代方案**: 直接复制源码、作为依赖安装、Fork + Pull方式
**影响**: 项目结构、开发流程、维护方式

## 2023-10-15 15:25: vnpy核心组件扩展策略
**决策**: 通过继承和扩展vnpy的核心组件，而非重写
**原因**:
- 保持与vnpy原有功能的兼容性
- 减少代码冗余和维护成本
- 便于跟随vnpy更新
**替代方案**: 完全重写核心组件、使用组合而非继承
**影响**: 代码结构、功能实现、维护复杂度

## [当前日期 时间]: 清理冗余代码并规范 API 实现路径
**决策**: 识别并删除旧的、未使用的 API 文件 (`simpletrade/api/data.py`)，确认未来 API 应在对应的 App 模块内定义 (`apps/<app_name>/api/routes.py`)，并通过依赖注入获取 App 引擎实例。
**原因**:
- 旧文件与当前 App 驱动的架构冲突，导致调试困难和混淆。
- 规范化 API 实现路径有助于保持代码库的清晰和一致性。
**替代方案**: 保留旧文件，尝试在主 API 路由器中合并或覆盖 App 的路由。
**影响**: 提高了代码库的可维护性，减少了潜在的混淆。明确了 API 的实现模式。

## [已废弃] [当前日期 时间]: 更新 AI 协作指南以强调代码整洁
**决策**: 在 `AI_COLLABORATION_GUIDE.md` 中明确添加规则，要求在开发过程中协助保持代码整洁，及时移除无用代码。
**原因**:
- 项目处于早期开发阶段，保持代码整洁至关重要。
- 明确规则有助于 AI 更好地协助维护代码质量。
**替代方案**: 不添加此规则，依赖开发者手动维护。
**影响**: 提升了 AI 协作维护代码质量的明确性。

## [已废弃] [当前日期 时间]: 确定数据下载/导入实现方案
**决策**: SimpleTrade 将自行在 `STDataManagerEngine` 中实现数据下载和导入逻辑（方案A），不再依赖 `vnpy_datamanager` 模块。
**原因**:
- 避免引入和维护额外的 `vnpy_datamanager` 源码模块。
- 保持 `STDataManagerEngine` 功能的内聚性。
- 对下载/导入过程有更精细的控制。
**替代方案**: 引入 `vnpy_datamanager` 源码并修复其依赖问题（方案B）。
**影响**: 需要自行编写下载（通过 Gateway）和导入（CSV 解析及数据库写入）的代码逻辑。暂时移除了对 `vnpy_datamanager` 的依赖，相关功能（下载、导入）需要重新实现。

## [部分调整] [当前日期 时间]: Tiger Gateway 按需连接
**决策**: 在 `STDataManagerEngine` 的 `download_bar_data` 方法中实现 Tiger Gateway 的按需连接 (Connect-on-demand) 逻辑。
**原因**:
- Tiger Gateway 源码没有提供简单的 `is_connected` 状态检查。
- 避免在服务器启动时强制连接 Gateway，增加灵活性。
- 连接状态通过检查核心客户端 (`gateway.quote_client`) 是否初始化来判断。
**替代方案**: 要求用户在执行下载前手动通过 API 或界面连接 Gateway；或在服务器启动时全局连接。
**影响**: 下载方法稍微复杂化，需要处理连接逻辑和异常。用户体验更佳，无需手动管理 Gateway 连接状态即可尝试下载。
**[更新]**: 此逻辑将移至新的交易中心后端实现。

## [已废弃] [当前日期 时间]: 本地自定义包 (`vnpy_tiger`) 的安装方式
**决策**: 对于像 `vnpy_tiger` 这样的本地自定义模块（包含 `setup.py`），使用 `pip install -e .` (在模块根目录下执行) 的方式进行可编辑安装。
**原因**:
- 这是处理包含 `setup.py` 的本地包的标准 Python 开发实践。
- 使其能被项目的其他部分正确 `import`。
- 修改本地源码后无需重新安装即可生效。
- 符合项目结构，避免直接修改 `sys.path`。
**替代方案**: 修改 `sys.path`；将 `vnpy_tiger` 代码直接整合到主项目中；将 `vnpy_tiger` 打包成 conda 包。
**影响**: 需要在环境设置中增加 `pip install -e .` 步骤。强调了项目存在本地开发包的情况。
**[更新]**: 决定使用 `sys.path` 方式加载 `vendors/vnpy_tiger`。

## [部分调整] [当前日期 时间]: 处理 conda 源缺失的依赖 (`tigeropen`)
**决策**: 对于 `conda` 官方或 `conda-forge` 源中不易找到的依赖包（如此次遇到的 `tigeropen`），允许在激活的 `simpletrade` conda 环境中使用 `pip install <package_name>` 进行安装。
**[更新]**: 需确认在新架构下是否仍需 `tigeropen`。

## 2025-04-13 Start of Day: 放弃vnpy源码集成
**决策**: 放弃使用 `vnpy` 及其官方插件的源码集成方式 (Git Submodules in `vendors/`)，改为使用标准的包管理器 (`pip`/`conda`) 安装。
**原因**: 简化环境管理，避免本地安装和路径问题。
**替代方案**: 继续使用源码集成。
**影响**: 环境设置更简单，但对 vnpy 的定制能力受限（主要通过插件和继承）。

## 2025-04-13 Mid-Day: vnpy_tiger 特殊处理
**决策**: 自定义 `vnpy_tiger` 无法通过 `pip` 安装，决定将其源码保留在 `vendors/` 目录，并通过修改 `sys.path` 在 `main.py` 中加载，其他 vnpy 库仍使用标准安装。
**原因**: `vnpy_tiger` 是非官方、本地修改的模块，无法通过标准包管理器安装。直接修改 `sys.path` 是在不打包的情况下使其可导入的最直接方式。
**替代方案**: 尝试将 `vnpy_tiger` 打包成本地 conda 包或 pip 包；将其代码合并到主项目中。
**影响**: 需要在 `main.py` 或类似入口文件维护 `sys.path` 修改逻辑。环境设置略微复杂化，但保留了使用自定义 Tiger Gateway 的能力。

## 2023-04-15 11:00: 创建长期规划路线图
**决策**: 创建长期规划路线图文档，记录集成n8n、dify和coze等开源项目的创新应用场景。
**原因**:
- 记录项目的长期发展方向和创新想法
- 为未来功能扩展提供参考和指导
- 将自动化工作流和AI助手集成到个人财务软件中，创造差异化竞争优势
**替代方案**: 仅关注当前阶段的功能开发，不记录长期规划。
**影响**:
- 为项目提供了更全面的发展视野
- 记录了有潜力的创新功能，如智能化个性定制的投资助手、智能触发的自动化交易生态系统、全方位财务健康管理中心等
- 为未来与微信生态系统的深度集成提供了规划
