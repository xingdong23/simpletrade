# SimpleTrade 项目状态

**最后更新**: 2025-04-12 11:45

## 项目概述
SimpleTrade是一个简单易用的个人量化交易平台，采用微信小程序/消息交互作为前端，支持策略交易、AI分析和实时监控等功能。项目直接使用vnpy源码作为基础，通过插件架构扩展功能，旨在让普通个人用户也能轻松使用量化交易技术。

## 当前阶段
规划与设计阶段 -> 文档完善阶段 -> [当前] 核心功能开发 -> 扩展功能开发 -> 测试与优化 -> 部署上线

## 已完成工作
- ✅ 项目整体规划与架构设计
- ✅ 核心文档编写:
  - 执行计划 (`docs/execution_plan.md`)
  - 功能需求文档 (`docs/functional_requirements.md`)
  - 技术规格文档 (`docs/technical_specification.md`)
  - vnpy集成指南 (`docs/vnpy_integration_guide.md`)
  - 界面设计文档 (`docs/ui_design.md`)
  - 消息交互设计文档 (`docs/message_interaction_design.md`)
  - AI模型训练与部署指南 (`docs/ai_model_guide.md`)
  - 品牌指南 (`docs/brand_guide.md`)
  - vnpy源码使用决策说明 (`docs/vnpy_source_decision.md`)
  - 架构设计文档 (`docs/architecture_diagram.md`)
- ✅ 项目名称确定为\"SimpleTrade\"
- ✅ 确定使用vnpy源码而非作为依赖安装
- ✅ 确定采用微信小程序和消息交互作为主要前端
- ✅ 创建独立项目结构
- ✅ 设计vnpy源码集成方案 (`docs/vnpy_integration_plan.md`)
- ✅ 创建项目基本目录结构和核心文件
- ✅ 设计核心引擎扩展代码框架
- ✅ 设计示例应用（交易增强应用）代码框架
- ✅ 创建vnpy环境配置和更新脚本
- ✅ 初始化Git仓库并添加vnpy作为子模块
- ✅ 在conda环境中成功安装项目依赖（包括解决特定平台问题）
- ✅ 开发数据管理功能，包括数据查询、导入、导出、删除等
- ✅ 实现数据管理API接口，提供RESTful API服务
- ✅ 实现数据分析功能，包括技术指标计算和策略回测
- ✅ 实现微信小程序API接口，支持用户认证和数据查询
- ✅ 实现数据管理消息处理器，支持通过消息指令管理数据
- ✅ 开发简单的Web前端，包括数据管理和数据分析功能
- ✅ 解决Web前端启动问题，包括API服务器启动错误和npm安装依赖错误
- ✅ 重组项目结构，使其更加清晰和有组织
- ✅ 实现老虎证券Gateway，支持历史数据下载和实时数据订阅
- ✅ 编写老虎证券Gateway相关文档，包括集成指南和使用指南
- ✅ 完善Web前端，增强用户界面和交互体验
- ✅ 开发交易中心、回测系统和AI分析等功能模块
- ✅ 检查并整理Web前端视图结构，确保与路由配置一致。
- ✅ 创建缺失的前端视图组件框架 (策略管理, 系统设置)。
- ✅ 解决前端项目编译和启动问题 (依赖, ESLint, 资源)。
- ✅ 启动前端开发服务器。
- ✅ 解决前后端联调中的系列依赖、环境、App注册问题。
- ✅ 解决前后端联调中的系列依赖、环境、App注册及**初始化错误** (包括修复本地 vnpy 源码问题)。
- ✅ 解决 `/api/data/overview` 持续返回调试数据的问题。
- ✅ 清理未使用的旧 API 文件 (`simpletrade/api/data.py`)。
- ✅ 更新 AI 协作指南，加入代码整洁规则。

## 进行中工作
- 🔄 补充文档编写:
  - 测试计划文档 (`docs/test_plan.md`)
  - 部署和运维文档 (`docs/deployment_operations.md`)
  - 项目词汇表 (`docs/glossary.md`)
  - 开发指南 (`docs/development_guidelines.md`)
- 🔄 核心引擎代码框架设计 (进度: 95%)
- 🔄 Web前端开发 (进度: 80% - 基本UI框架完成，**API 阻塞问题已解决，可以进行联调**)
- 🔄 API服务框架开发 (进度: 90% - **核心数据概览 API 已修复，可以进行联调**)
- 🔄 **数据下载/导入功能实现 (方案A)** (进度: 30% - `download_bar_data` 框架及按需连接逻辑已实现，待测试)
- 🔄 API服务框架开发 (进度: 90% - **后端问题已解决，API应可正常工作**)
- 🔄 数据分析功能开发 (进度: 70%)

## 待开始工作
- ⏳ 数据库配置与实现
- ⏳ 核心功能开发:
  - 交易接口连接
  - 基本交易操作
  - 数据展示
- ⏳ 策略管理与回测功能
- ⏳ AI分析功能
- ⏳ 微信小程序开发（后期考虑）
- ⏳ 消息交互系统开发（后期考虑）

## 技术栈
- 后端: Python, vnpy框架(直接使用源码), FastAPI
- API: FastAPI
- 数据库: SQLite (通过 vnpy_sqlite)
- 前端: Vue.js, HTML/CSS/JavaScript
- AI: Scikit-learn, PyTorch, OpenAI API
- 环境管理: Conda (`simpletrade` 环境)

## 关键决策
1. 使用vnpy源码而非作为依赖安装，以获得最大灵活性
2. 采用插件架构扩展vnpy功能
3. 使用微信小程序和消息交互作为主要前端（Web前端优先开发）
4. 项目名称确定为\"SimpleTrade\"
5. 采用结构化项目状态文件方法管理AI协作
6. 使用轻量级数据存储方案(SQLite + 文件存储)，适合个人项目和单服务器环境
7. 采用Git子模块方式集成vnpy源码
8. 通过继承和扩展vnpy的核心组件，而非重写
9. 使用vnpy的最新版本（4.0.0+）而非原计划的2.3.0版本
10. 使用conda环境来管理项目依赖，所有应用安装和命令行操作必须在激活的`simpletrade` conda环境中进行。
11. 覆盖 `STMainEngine.add_app` 以正确实例化自定义 App。

## 最近会话
- [2023-10-15 10:30] 完成了项目文档计划更新，确认了已完成和待完成的文档
- [2023-10-15 11:15] 创建了消息交互设计、AI模型训练与部署指南、品牌指南和vnpy源码使用决策说明文档
- [2023-10-15 13:00] 讨论并确定了AI协作优化方案，创建了AI上下文管理结构
- [2023-10-15 14:20] 设计了项目架构图，确定了轻量级数据存储方案
- [2023-10-15 14:45] 创建了独立的SimpleTrade项目结构
- [2023-10-15 15:30] 设计了vnpy源码集成方案，创建了项目基本框架和核心组件代码
- [2023-10-15 16:05] 澄清了vnpy源码集成的实际状态，修正了进度描述
- [2024-04-11 17:50] 执行vnpy源码集成，使用最新版本（4.0.0+）并在conda环境中成功安装，规定所有应用安装必须使用conda，并始终使用同一个simpletrade环境
- [2024-04-12 14:00] 开发数据管理功能，包括数据查询、导入、导出、删除等功能，并集成vnpy的数据模型和管理功能
- [2024-04-12 16:30] 开发简单的Web前端，包括数据管理和数据分析功能，并重组项目结构，使其更加清晰和有组织
- [2024-04-12 17:30] 修复API服务器启动问题，并改进启动脚本的错误处理和进程管理
- [2024-04-13 15:30] 完全解决Web前端启动问题，创建简单版HTML前端，并修复API跨域问题和缺失的API端点
- [2024-04-13 17:30] 实现老虎证券Gateway，支持历史数据下载和实时数据订阅
- [2024-04-13 18:00] 编写老虎证券Gateway相关文档，包括集成指南和使用指南
- [2024-04-13 19:00] 决定优先完善Web前端而非微信小程序，将微信小程序开发推迟到后期
- [2024-04-13 21:00] 完善Web前端，开发交易中心、回测系统和AI分析等功能模块
- [2025-04-11 12:18] 完成了Web前端主要视图组件的检查、整理和创建，解决了编译和启动过程中的多个问题，成功启动了前端开发服务器。
- [当前日期 时间] 调试并修复了 `/api/data/overview` 端点的一系列问题（错误的 API 文件、引擎初始化参数、属性引用、依赖注入、方法缺失），删除了旧 API 文件，更新了协作指南。API 现已可用但数据库为空。
- [当前日期 时间] 决定自行实现数据下载/导入；解决了模块查找问题（vnpy_datamanager, vnpy_tiger）；实现了 `download_bar_data` 的按需连接逻辑；用户暂停，下次将测试下载功能。
- 2025-04-12 11:30 成功修复后端 App 初始化及 vnpy 源码问题，API 服务恢复正常。
- 2025-04-12 11:45 尝试解决 API `/api/data/overview` 持续返回调试信息的问题，但重启、清除缓存后问题依旧存在，原因待查。

## 未完成工作和遇到的问题

### [已解决] App 初始化 TypeError
- **问题描述**: 在全局范围注册自定义 App (`STMessageApp`, `STTraderApp`, `STDataManagerApp`) 时，发生 `TypeError: STBaseApp.__init__() missing 2 required positional arguments: \'main_engine\' and \'event_engine\'`。
- **原因**: 这些自定义 App 类的 `__init__` 方法没有正确定义或继承接受 `main_engine` 和 `event_engine` 的构造函数，导致 `STMainEngine.add_app` 尝试用这两个参数实例化它们时失败。
- **解决方案**: 需要开发者手动修改 `STMessageApp`, `STTraderApp`, `STDataManagerApp` 的 `__init__` 方法，使其接受所需参数并正确调用 `super().__init__()`。
- **状态**: **已解决** (通过修复自定义 App 类的 `__init__` 方法以及本地 vnpy 源码中的相关问题)

### [新增] API 端点持续返回调试数据
- **问题描述**: `/api/data/overview` 端点持续返回硬编码的调试响应 (`{"success":true,"message":"获取数据概览成功 (调试模式)","data":[]}`)，即使磁盘上的代码 (`simpletrade/api/data.py`) 已被修正为返回真实数据。
- **尝试的解决方案**: 重启服务器 (使用/不使用 `--reload`)，清除 Python 字节码缓存 (`__pycache__`)，强制停止旧进程。
- **可能原因**: 残留的旧服务器进程、环境路径问题、代码加载/重载机制故障、或其他未知环境因素。
- **状态**: **待解决 (阻碍前端数据展示和后续联调)**

### [已解决] Web前端启动问题
- **状态**: 已解决 (所有依赖问题和环境问题均已解决，API 500 错误根源已找到)

### 项目结构混乱
- **状态**: 已解决，但需要更新文档说明各个目录的用途

### 可视化前端
- **状态**: 已解决，基本功能完善，后续可根据需求继续优化

### [新增] 数据库为空
- **问题描述**: 当前 vnpy 数据库中没有历史数据，需要添加数据才能进行完整的前后端联调和功能测试。
- **解决方案**: 通过下载 (e.g., Tiger Gateway) 或导入 CSV 的方式添加数据。
- **状态**: **待解决**

### [新增] 数据下载/导入功能未完全实现和测试
- **问题描述**: 已选择方案A自行实现，`download_bar_data` 框架已完成但未测试，`import_data_from_csv` 待实现。
- **解决方案**: 需要实现 `import_data_from_csv` 功能。
- **状态**: **待解决**

### 数据库为空
- **问题描述**: 需要通过下载或导入添加数据。
- **解决方案**: 通过下载 (e.g., Tiger Gateway) 或导入 CSV 的方式添加数据。
- **状态**: **待解决**

### Pydantic V2 警告
- **问题描述**: 需要更新代码以兼容 Pydantic V2 配置。
- **解决方案**: 需要更新代码以兼容 Pydantic V2 配置。
- **状态**: **待解决**

## 下一步计划
1.  **测试数据下载**: 调用 `/api/data/download` 尝试下载少量数据 (e.g., AAPL 日线)。
2.  **验证数据下载**: 检查日志和 `/api/data/overview` 确认数据是否入库。
3.  (成功后) 实现 `import_data_from_csv` 功能。
4.  (数据可用后) 前后端联调: 继续将前端数据管理模块与后端 API 进行联调。
5.  连接其他前端模块与后端 API。
6.  完善各模块功能。
7.  完善文档和测试。
8.  处理 Pydantic V2 警告。
