# SimpleTrade 项目基础架构设计

## 1. 系统架构概览

```
+--------------------------------------------------------------------------------------------------+
|                                       用户交互层                                                  |
|  +----------------+    +----------------+    +----------------+    +----------------+             |
|  |  微信小程序    |    |   消息交互     |    |    H5页面      |    |   通知系统     |             |
|  +-------+--------+    +-------+--------+    +-------+--------+    +-------+--------+             |
+----------|--------------------|----------------------|----------------------|----------------------+
           |                    |                      |                      |
           v                    v                      v                      v
+--------------------------------------------------------------------------------------------------+
|                                       API网关层                                                   |
|  +--------------------------------------------------------------------------------+              |
|  |                              FastAPI REST接口                                  |              |
|  +--------------------------------------------------------------------------------+              |
|  |                              WebSocket实时接口                                 |              |
|  +--------------------------------------------------------------------------------+              |
+--------------------------------------------------------------------------------------------------+
           |                    |                      |                      |
           v                    v                      v                      v
+--------------------------------------------------------------------------------------------------+
|                                       业务逻辑层                                                  |
|  +----------------+    +----------------+    +----------------+    +----------------+             |
|  |   账户管理     |    |   交易执行     |    |   策略管理     |    |   数据分析     |             |
|  +----------------+    +----------------+    +----------------+    +----------------+             |
|  +----------------+    +----------------+    +----------------+    +----------------+             |
|  |   风险控制     |    |   回测系统     |    |   监控告警     |    |   AI模型服务   |             |
|  +----------------+    +----------------+    +----------------+    +----------------+             |
+--------------------------------------------------------------------------------------------------+
           |                    |                      |                      |
           v                    v                      v                      v
+--------------------------------------------------------------------------------------------------+
|                                       核心引擎层 (vnpy)                                           |
|  +----------------+    +----------------+    +----------------+    +----------------+             |
|  |   事件引擎     |    |   交易引擎     |    |   行情引擎     |    |   风控引擎     |             |
|  +----------------+    +----------------+    +----------------+    +----------------+             |
|  +----------------+    +----------------+    +----------------+                                   |
|  |   策略引擎     |    |   数据引擎     |    |   回测引擎     |                                   |
|  +----------------+    +----------------+    +----------------+                                   |
+--------------------------------------------------------------------------------------------------+
           |                    |                      |                      |
           v                    v                      v                      v
+--------------------------------------------------------------------------------------------------+
|                                       数据存储层                                                  |
|  +----------------+    +----------------+    +----------------+                                   |
|  |    SQLite      |    |  文件存储      |    |   日志文件     |                                   |
|  | (核心数据库)   |    | (行情历史数据) |    |                |                                   |
|  +----------------+    +----------------+    +----------------+                                   |
+--------------------------------------------------------------------------------------------------+
           |                    |                      |                      |
           v                    v                      v                      v
+--------------------------------------------------------------------------------------------------+
|                                       外部接口层                                                  |
|  +----------------+    +----------------+    +----------------+    +----------------+             |
|  |   交易接口     |    |   行情接口     |    |   OpenAI API   |    |   其他第三方   |             |
|  | (期货/股票等)  |    | (实时/历史)    |    |                |    |                |             |
|  +----------------+    +----------------+    +----------------+    +----------------+             |
+--------------------------------------------------------------------------------------------------+
```

## 2. 组件详细说明

### 2.1 用户交互层

#### 微信小程序
- 提供移动端交易操作界面
- 实时行情和账户信息展示
- 简化的策略配置和监控

#### 消息交互
- 基于微信消息的命令式交互
- 支持自然语言处理的交易指令
- 交易通知和警报推送

#### H5页面
- 更复杂的数据可视化和分析工具
- 详细的策略配置和回测界面
- 响应式设计，支持移动端和桌面端

#### 通知系统
- 交易执行通知
- 风险预警
- 策略信号提醒

### 2.2 API网关层

#### FastAPI REST接口
- 用户认证和授权
- 交易指令处理
- 数据查询和管理
- 策略配置和管理

#### WebSocket实时接口
- 实时行情推送
- 账户状态更新
- 交易执行反馈
- 策略信号实时通知

### 2.3 业务逻辑层

#### 账户管理
- 用户注册和认证
- 账户配置和权限管理
- 资金管理和统计

#### 交易执行
- 订单生成和验证
- 交易路由和执行
- 成交管理和记录

#### 策略管理
- 策略创建和配置
- 策略部署和运行
- 策略监控和调整

#### 数据分析
- 市场数据分析
- 交易绩效评估
- 技术指标计算

#### 风险控制
- 交易限额管理
- 风险指标监控
- 自动风控规则执行

#### 回测系统
- 历史数据回测
- 策略优化
- 绩效分析报告

#### 监控告警
- 系统状态监控
- 异常交易检测
- 预设条件告警

#### AI模型服务
- 市场预测模型
- 策略优化建议
- 自然语言处理

### 2.4 核心引擎层 (vnpy)

#### 事件引擎
- 系统内部事件驱动机制
- 模块间通信

#### 交易引擎
- 订单管理和执行
- 持仓管理
- 成交记录

#### 行情引擎
- 实时行情订阅和处理
- 行情数据规范化

#### 风控引擎
- 交易前风险检查
- 持仓风险监控

#### 策略引擎
- 策略加载和运行
- 信号生成和执行

#### 数据引擎
- 历史数据管理
- 数据清洗和存储

#### 回测引擎
- 历史数据回放
- 模拟交易执行
- 绩效统计

### 2.5 数据存储层

#### SQLite
- 用户账户数据
- 策略配置数据
- 交易记录
- 系统配置
- 简单的缓存和队列实现
- 指标计算结果

#### 文件存储
- 行情历史数据 (使用HDF5/Parquet/CSV格式)
- 按时间/品种组织的数据文件
- 简单索引机制加速查询
- 大型数据集存储

#### 日志文件
- 系统日志
- 交易日志
- 错误和异常记录
- 日志轮转机制

### 2.6 外部接口层

#### 交易接口
- 期货交易接口
- 股票交易接口
- 其他金融产品接口

#### 行情接口
- 实时行情数据源
- 历史行情数据源

#### OpenAI API
- 自然语言处理
- 交易指令解析
- 市场分析辅助

#### 其他第三方
- 短信服务
- 邮件服务
- 云存储服务

## 3. 数据流

### 3.1 交易流程
```
用户 -> 微信小程序/消息 -> API网关 -> 业务逻辑层 -> 核心引擎 -> 外部交易接口 -> 交易所
```

### 3.2 行情数据流
```
外部行情接口 -> 核心引擎 -> 数据存储 -> 业务逻辑层 -> API网关 -> 用户界面
```

### 3.3 策略执行流
```
策略配置 -> 策略引擎 -> 信号生成 -> 交易引擎 -> 风控检查 -> 交易执行 -> 成交反馈
```

## 4. 部署架构

### 4.1 开发环境
- 本地开发环境
- SQLite测试数据库
- 模拟交易接口
- 本地文件存储

### 4.2 单服务器生产环境
- 单一服务器运行所有组件
- 使用进程管理工具(如Supervisor)管理服务
- 资源限制和监控
- 定期备份至外部存储

### 4.3 服务器资源分配
- 核心交易服务: 优先分配资源
- 数据存储: 适当的磁盘空间规划
- 定时任务: 在低负载时段运行
- 监控和告警: 轻量级监控解决方案

## 5. 扩展性考虑

### 5.1 水平扩展
- API服务可以部署多个实例，通过负载均衡分发请求
- 数据处理和分析模块可以独立扩展

### 5.2 垂直扩展
- 核心交易引擎可以针对性能需求进行优化
- 数据库可以根据数据量增长进行升级

### 5.3 模块化设计
- 各功能模块通过明确的接口进行通信
- 新功能可以作为插件方式添加，不影响现有系统

## 6. 资源优化策略

### 6.1 单服务器部署优化
- 单进程多线程架构
- 异步编程模型处理并发
- 按需启动服务组件
- 资源使用监控和限制

### 6.2 数据存储优化
- SQLite数据库索引优化
- 内存缓存层减少磁盘I/O
- 批量操作替代频繁的单条操作
- 数据归档和清理策略

### 6.3 计算资源管理
- 任务优先级队列
- 实时交易任务优先处理
- 非关键任务安排在低负载时段
- 优雅的降级策略

## 7. 安全考虑

### 7.1 认证和授权
- 多因素认证
- 基于角色的访问控制
- API密钥管理

### 7.2 数据安全
- 敏感数据加密存储
- 传输加密 (HTTPS/WSS)
- 定期数据备份

### 7.3 操作安全
- 交易操作审计日志
- 异常操作检测
- 风险控制规则
