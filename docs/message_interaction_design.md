# SimpleTrade 消息交互设计文档

**版本**: 0.1  
**日期**: 2023-10-15  
**状态**: 初稿  

## 1. 文档目的

本文档详细描述 SimpleTrade 交易平台的消息交互设计，包括通过微信、飞书等消息平台进行交易操作和系统控制的方式，为开发团队提供明确的消息交互规范。

## 2. 消息交互概述

SimpleTrade 支持通过消息指令的方式进行交易操作和系统控制，用户可以在微信、飞书等平台发送特定格式的消息，系统会解析这些消息并执行相应的操作，然后返回操作结果。

### 2.1 支持的平台

- **微信个人号**: 通过私聊发送指令
- **微信公众号**: 通过关注公众号发送指令
- **企业微信**: 通过企业微信机器人发送指令
- **飞书**: 通过飞书机器人发送指令

### 2.2 交互流程

```
用户 --> 发送消息指令 --> 消息平台 --> SimpleTrade消息处理服务
  ^                                       |
  |                                       v
  +------- 返回操作结果 <-----------------+
```

### 2.3 消息格式

所有消息指令采用以下格式：

```
/命令 参数1 参数2 ...
```

例如：
```
/买入 600000 100 市价
/查询 持仓
/启动 策略1
```

## 3. 指令系统设计

### 3.1 指令分类

SimpleTrade 的消息指令分为以下几类：

1. **交易指令**: 用于执行交易操作
2. **查询指令**: 用于查询账户和市场信息
3. **策略指令**: 用于管理交易策略
4. **系统指令**: 用于系统控制和设置
5. **分析指令**: 用于请求AI分析

### 3.2 指令详细说明

#### 3.2.1 交易指令

| 指令 | 格式 | 参数说明 | 示例 | 返回内容 |
|-----|------|---------|------|---------|
| 买入 | /买入 股票代码 数量 [价格] [类型] | 股票代码: 如600000<br>数量: 购买数量<br>价格: 可选，默认为市价<br>类型: 可选，"限价"或"市价"，默认"限价" | /买入 600000 100 50.5<br>/买入 600000 100 市价 | 订单提交结果，包含订单ID和状态 |
| 卖出 | /卖出 股票代码 数量 [价格] [类型] | 同买入 | /卖出 600000 100 51.5<br>/卖出 600000 100 市价 | 订单提交结果，包含订单ID和状态 |
| 撤单 | /撤单 订单ID | 订单ID: 要撤销的订单ID | /撤单 ord123456 | 撤单结果，成功或失败原因 |
| 全撤 | /全撤 | 无 | /全撤 | 撤销所有未成交订单的结果 |
| 平仓 | /平仓 股票代码 [数量] | 股票代码: 如600000<br>数量: 可选，默认全部平仓 | /平仓 600000<br>/平仓 600000 50 | 平仓订单提交结果 |
| 全平 | /全平 | 无 | /全平 | 平仓所有持仓的结果 |

#### 3.2.2 查询指令

| 指令 | 格式 | 参数说明 | 示例 | 返回内容 |
|-----|------|---------|------|---------|
| 查询 | /查询 类型 [参数] | 类型: "账户"、"持仓"、"订单"、"成交"<br>参数: 可选，如股票代码 | /查询 账户<br>/查询 持仓<br>/查询 订单<br>/查询 成交 | 相应类型的信息摘要 |
| 行情 | /行情 股票代码 | 股票代码: 如600000 | /行情 600000 | 股票当前行情，包括价格、涨跌幅等 |
| 资金 | /资金 | 无 | /资金 | 账户资金信息，包括总资产、可用资金等 |
| 持仓 | /持仓 [股票代码] | 股票代码: 可选，特定股票的持仓 | /持仓<br>/持仓 600000 | 持仓信息，包括股票、数量、成本、盈亏等 |
| 订单 | /订单 [订单ID] | 订单ID: 可选，特定订单的详情 | /订单<br>/订单 ord123456 | 订单信息，包括状态、成交情况等 |

#### 3.2.3 策略指令

| 指令 | 格式 | 参数说明 | 示例 | 返回内容 |
|-----|------|---------|------|---------|
| 策略列表 | /策略列表 | 无 | /策略列表 | 所有策略的列表和状态 |
| 策略详情 | /策略详情 策略名称 | 策略名称: 要查询的策略名称 | /策略详情 策略1 | 策略的详细信息，包括参数、状态、绩效等 |
| 启动策略 | /启动 策略名称 | 策略名称: 要启动的策略名称 | /启动 策略1 | 策略启动结果 |
| 停止策略 | /停止 策略名称 | 策略名称: 要停止的策略名称 | /停止 策略1 | 策略停止结果 |
| 策略绩效 | /绩效 策略名称 | 策略名称: 要查询绩效的策略名称 | /绩效 策略1 | 策略绩效摘要，包括收益率、夏普比率等 |

#### 3.2.4 系统指令

| 指令 | 格式 | 参数说明 | 示例 | 返回内容 |
|-----|------|---------|------|---------|
| 帮助 | /帮助 [指令类别] | 指令类别: 可选，如"交易"、"查询"等 | /帮助<br>/帮助 交易 | 指令帮助信息 |
| 状态 | /状态 | 无 | /状态 | 系统状态信息，包括连接状态、运行时间等 |
| 设置 | /设置 参数名 参数值 | 参数名: 要设置的参数<br>参数值: 新的参数值 | /设置 通知 开启 | 设置结果 |
| 登录 | /登录 | 无 | /登录 | 返回登录链接或二维码 |
| 退出 | /退出 | 无 | /退出 | 退出登录结果 |

#### 3.2.5 分析指令

| 指令 | 格式 | 参数说明 | 示例 | 返回内容 |
|-----|------|---------|------|---------|
| 分析 | /分析 股票代码 [周期] | 股票代码: 如600000<br>周期: 可选，如"日"、"周"、"月"，默认"日" | /分析 600000<br>/分析 600000 周 | AI分析结果摘要 |
| 预测 | /预测 股票代码 [天数] | 股票代码: 如600000<br>天数: 可选，预测未来天数，默认5天 | /预测 600000<br>/预测 600000 10 | 价格趋势预测结果 |
| 热点 | /热点 [行业] | 行业: 可选，特定行业的热点 | /热点<br>/热点 科技 | 市场热点分析 |
| 资讯 | /资讯 [股票代码] | 股票代码: 可选，特定股票的相关资讯 | /资讯<br>/资讯 600000 | 最新市场或个股资讯 |

### 3.3 指令参数格式

#### 3.3.1 股票代码格式

- **A股**: 6位数字，如"600000"、"000001"
- **港股**: 5位数字前加"hk"，如"hk00700"
- **美股**: 股票代码前加"us."，如"us.aapl"

#### 3.3.2 数量格式

- 整数表示股数，如"100"表示100股
- 可使用"手"作为单位，如"1手"表示100股（A股）

#### 3.3.3 价格格式

- 数字表示价格，如"50.5"
- 特殊关键字"市价"表示市价单

#### 3.3.4 日期格式

- 使用"YYYY-MM-DD"格式，如"2023-10-15"
- 可使用相对日期，如"今天"、"昨天"、"7天前"

## 4. 响应设计

### 4.1 响应格式

所有响应消息采用以下格式：

```
[状态] 标题
---------
内容
---------
时间戳
```

例如：
```
[成功] 买入订单已提交
---------
股票: 浦发银行(600000)
数量: 100股
价格: 市价
订单ID: ord123456
状态: 已提交
---------
2023-10-15 15:30:45
```

### 4.2 响应类型

#### 4.2.1 成功响应

成功响应使用"[成功]"前缀，并提供操作结果的详细信息。

#### 4.2.2 错误响应

错误响应使用"[错误]"前缀，并提供错误原因和可能的解决方法。

例如：
```
[错误] 买入订单提交失败
---------
原因: 资金不足
可用资金: 5,000元
所需资金: 10,000元
---------
2023-10-15 15:30:45
```

#### 4.2.3 警告响应

警告响应使用"[警告]"前缀，提示用户潜在的风险或注意事项。

例如：
```
[警告] 大额交易提醒
---------
您正在进行大额交易，超过账户资产的30%
请确认是否继续执行
回复"确认"继续，回复"取消"放弃
---------
2023-10-15 15:30:45
```

#### 4.2.4 信息响应

信息响应使用"[信息]"前缀，提供中性的信息内容。

例如：
```
[信息] 系统状态
---------
连接状态: 正常
运行时间: 3天5小时
策略运行: 2个
CPU使用率: 25%
内存使用: 512MB
---------
2023-10-15 15:30:45
```

### 4.3 富媒体响应

对于复杂的信息，如图表、分析报告等，系统可以返回富媒体内容。

#### 4.3.1 图片响应

对于K线图、技术指标图等，系统返回图片和简要文字说明。

#### 4.3.2 链接响应

对于详细报告、完整数据等，系统返回链接，用户可以点击查看Web页面上的完整内容。

#### 4.3.3 交互式响应

对于需要用户进一步操作的情况，系统可以返回交互式内容，如按钮、选择列表等。

## 5. 安全与权限

### 5.1 用户认证

用户需要先完成认证才能使用消息指令功能：

1. **初次使用**: 用户需要通过Web界面或小程序完成账户绑定
2. **身份验证**: 系统通过消息平台的用户ID识别用户身份
3. **会话管理**: 用户会话有效期为24小时，超时需要重新登录

### 5.2 操作权限

不同级别的用户有不同的操作权限：

1. **基础用户**: 只能查询信息，不能执行交易操作
2. **交易用户**: 可以执行交易操作，但有金额限制
3. **高级用户**: 可以执行所有操作，包括策略管理
4. **管理员**: 可以执行系统管理操作

### 5.3 安全措施

为保障交易安全，系统采取以下安全措施：

1. **交易确认**: 大额交易需要二次确认
2. **操作限流**: 限制短时间内的操作次数
3. **异常检测**: 检测异常操作模式并要求验证
4. **敏感操作通知**: 敏感操作会通过备用渠道通知用户

## 6. 实现方案

### 6.1 消息处理流程

```
1. 接收消息 --> 2. 解析指令 --> 3. 验证用户权限
       |                           |
       v                           v
4. 执行操作 <-- 5. 参数验证 <-- 6. 业务逻辑检查
       |
       v
7. 生成响应 --> 8. 发送响应
```

### 6.2 技术实现

#### 6.2.1 微信接入

使用微信公众平台API或企业微信API接入：

```python
# 微信公众号消息处理示例
@app.route('/wechat', methods=['POST'])
def handle_wechat_message():
    # 解析微信消息
    msg = parse_wechat_message(request.data)
    
    # 处理指令
    if msg.startswith('/'):
        response = process_command(msg, user_id)
    else:
        response = get_help_message()
    
    # 返回响应
    return format_wechat_response(response)
```

#### 6.2.2 飞书接入

使用飞书开放平台API接入：

```python
# 飞书机器人消息处理示例
@app.route('/feishu', methods=['POST'])
def handle_feishu_message():
    # 解析飞书消息
    data = request.get_json()
    msg = data['text']['content']
    user_id = data['sender']['sender_id']
    
    # 处理指令
    if msg.startswith('/'):
        response = process_command(msg, user_id)
    else:
        response = get_help_message()
    
    # 返回响应
    return {
        'msg_type': 'text',
        'content': {'text': response}
    }
```

#### 6.2.3 指令解析

使用正则表达式解析指令和参数：

```python
def parse_command(command_text):
    """解析指令文本，提取命令和参数"""
    # 匹配命令格式: /命令 参数1 参数2 ...
    pattern = r'^/(\w+)\s*(.*?)$'
    match = re.match(pattern, command_text)
    
    if not match:
        return None, []
    
    command = match.group(1)
    params_text = match.group(2)
    
    # 解析参数，考虑引号内的空格
    params = []
    if params_text:
        # 使用正则表达式匹配带引号的参数
        param_pattern = r'([^\s"]+)|"([^"]*)"'
        for match in re.finditer(param_pattern, params_text):
            # 取非空的组作为参数
            param = match.group(1) or match.group(2)
            params.append(param)
    
    return command, params
```

## 7. 测试计划

### 7.1 单元测试

对指令解析、参数验证、响应生成等核心功能进行单元测试。

### 7.2 集成测试

测试与各消息平台的集成，确保消息能正确接收和发送。

### 7.3 用户测试

邀请真实用户进行测试，收集反馈并优化交互体验。

## 8. 修订历史

| 版本 | 日期 | 描述 | 作者 |
|-----|------|------|------|
| 0.1 | 2023-10-15 | 初稿 | AI助手 |
